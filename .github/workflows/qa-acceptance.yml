name: QA - Unit + Acceptance Evidence

on:
  push:
    branches: [ deploy ]
  pull_request:
    branches: [ deploy ]

jobs:
  unit-tests:
    name: Unit Tests (pytest) + HTML Evidence
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r DevOpsFilePortal/requirements.txt
          pip install pytest pytest-html

      - name: Run pytest with HTML report
        working-directory: DevOpsFilePortal
        run: |
          pytest -q --html=pytest-report.html --self-contained-html

      - name: Upload pytest HTML report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: DevOpsFilePortal/pytest-report.html

  acceptance:
    name: Acceptance Smoke Test (docker compose) + Logs Evidence
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v4

      - name: Build & run app (docker compose)
        working-directory: DevOpsFilePortal
        run: |
          docker compose up -d --build

      - name: Wait for app to be ready
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:5000/login > /dev/null; then
              echo "App is up."
              exit 0
            fi
            echo "Waiting for app... ($i/30)"
            sleep 2
          done
          echo "App did not become ready in time."
          docker compose logs --no-color
          exit 1

      - name: Basic acceptance checks (HTTP)
        run: |
          curl -fsS http://localhost:5000/login | head -n 20
          # Optional: check dashboard redirects when not logged in
          curl -fsSI http://localhost:5000/dashboard | head -n 20

      - name: Capture docker logs as evidence
        if: always()
        working-directory: DevOpsFilePortal
        run: |
          docker compose logs --no-color > docker-compose-logs.txt

      - name: Upload acceptance evidence (logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: acceptance-logs
          path: DevOpsFilePortal/docker-compose-logs.txt

      - name: Tear down
        if: always()
        working-directory: DevOpsFilePortal
        run: |
          docker compose down -v
