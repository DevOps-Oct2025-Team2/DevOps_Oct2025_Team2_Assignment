# .github/workflows/2-promote-deploy-to-staging.yml
# Garence Wong Kar Kang
name: Promote - deploy to staging

on:
  workflow_run:
    workflows: ["CI - Deploy"]
    types: [completed]

permissions:
  contents: read
  pull-requests: write

jobs:
  create_pr:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'deploy'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (needed for gh cli to have repo context)
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Create PR if not exists (deploy -> staging)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          if git ls-remote --exit-code origin deploy >/dev/null 2>&1 && git ls-remote --exit-code origin staging >/dev/null 2>&1; then
            git fetch origin deploy staging --depth=1
            if git merge-base --is-ancestor origin/deploy origin/staging; then
              echo "No new commits to promote (deploy already included in staging)."
              exit 0
            fi
          fi

          existing=$(gh pr list --base staging --head deploy --state open --json number --jq '.[0].number')
          if [ -n "$existing" ]; then
            echo "PR already exists: #$existing"
            exit 0
          fi

          gh pr create \
            --base staging \
            --head deploy \
            --title "Auto PR: deploy â†’ staging (CI passed)" \
            --body "Auto-generated after CI success on deploy. QA: review and merge when ready."
