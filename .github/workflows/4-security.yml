name: 4. Comprehensive Security Pipeline (SAST + SCA + DAST + Secrets)

on:
  push:
    branches: [ deploy ]
  pull_request:
    branches: [ deploy ]
  schedule:
    - cron: '0 0 * * 0' # Weekly run on Sundays

permissions:
  contents: read
  security-events: write
  issues: write
  actions: read

jobs:
  # ------------------------------------------------------------------
  # JOB 1: SECRET SCANNING (New Layer)
  # Detects hardcoded secrets/credentials in the codebase
  # ------------------------------------------------------------------
  secret-scan:
    name: "ðŸ”‘ Secret Scanning (TruffleHog)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for secret scanning

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # ------------------------------------------------------------------
  # JOB 2: SAST (Static Application Security Testing)
  # CodeQL Analysis
  # ------------------------------------------------------------------
  sast-codeql:
    name: "ðŸ›¡ï¸ SAST (CodeQL)"
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # ------------------------------------------------------------------
  # JOB 3: SCA (Software Composition Analysis)
  # Check for known vulnerabilities in dependencies
  # ------------------------------------------------------------------
  sca-dependency-check:
    name: "ðŸ“¦ SCA (Dependency Check)"
    runs-on: ubuntu-latest
    needs: [secret-scan] # Run after quick secret scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f DevOpsFilePortal/requirements.txt ]; then pip install -r DevOpsFilePortal/requirements.txt; fi

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'DevOpsFilePortal'
          path: './DevOpsFilePortal'
          format: 'ALL'
          out: 'reports'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Upload SCA Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dep-check-report
          path: reports

  # ------------------------------------------------------------------
  # JOB 4: DAST (Dynamic Application Security Testing)
  # Live scan of the running application using OWASP ZAP
  # ------------------------------------------------------------------
  dast-zap-scan:
    name: "ðŸŒ©ï¸ DAST (OWASP ZAP)"
    runs-on: ubuntu-latest
    needs: [sast-codeql, sca-dependency-check] # Validation before live scan
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f DevOpsFilePortal/requirements.txt ]; then pip install -r DevOpsFilePortal/requirements.txt; fi

      - name: Start Application (Background)
        run: |
          cd DevOpsFilePortal
          nohup python app.py > app.log 2>&1 &
          echo "Waiting for app to start..."
          for i in {1..30}; do
            curl -s http://localhost:5000 > /dev/null && echo "App is up!" && break
            sleep 1
          done
          cat app.log

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: false
          artifact_name: 'zap-baseline-scan'
        continue-on-error: true

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: 'http://localhost:5000'
          cmd_options: '-a -j'
          allow_issue_writing: false
          artifact_name: 'zap-full-scan'
      
      - name: Fail if High alerts found
        run: |
          if [ -f report_json.json ]; then
            high=$(python -c "import json; d=json.load(open('report_json.json')); \
              alerts=d.get('site',[{}])[0].get('alerts',[]); \
              print(sum(1 for a in alerts if str(a.get('riskdesc','')).lower().startswith('high')))")

            echo "High alerts: $high"
            if [ "$high" -gt 0 ]; then
              echo "âŒ Failing due to High risk ZAP alerts"
              exit 1
            fi
          fi
      
      - name: Upload ZAP Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: |
            report_html.html
            report_json.json
            report_md.md

  # ------------------------------------------------------------------
  # JOB 5: REPORTING
  # Summarize findings in the GitHub Step Summary
  # ------------------------------------------------------------------
  security-summary:
    name: "ðŸ“Š Security Report Card"
    runs-on: ubuntu-latest
    if: always()
    needs: [secret-scan, sast-codeql, sca-dependency-check, dast-zap-scan]

    steps:
      - name: Create Summary
        run: |
          echo "# ðŸ›¡ï¸ Security Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "| Security Layer | Status | Tool |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Secrets** | ${{ needs.secret-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | TruffleHog |" >> $GITHUB_STEP_SUMMARY
          echo "| **SAST** | ${{ needs.sast-codeql.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | CodeQL |" >> $GITHUB_STEP_SUMMARY
          echo "| **SCA** | ${{ needs.sca-dependency-check.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | OWASP Dependency Check |" >> $GITHUB_STEP_SUMMARY
          echo "| **DAST** | ${{ needs.dast-zap-scan.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} | OWASP ZAP |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review the **Security** tab and **Artifacts** for detailed logs." >> $GITHUB_STEP_SUMMARY
